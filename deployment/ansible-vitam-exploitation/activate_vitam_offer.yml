---
- import_playbook: stop_vitam.yml

- hosts: localhost
  roles:
    - { role: storage_offer_activation, vars: { do_action: "list_offers"} }

# List all strategy offers and disable the chosen one
- hosts: localhost
  any_errors_fatal: yes
  vars:
    offers_names_flattened: " {{ hostvars['localhost']['offers_name_list'] |join('\n  ') }}"
  vars_prompt:
    name: "offer_name_resp"
    prompt: "Which offer do you want to disable ?\n {{ offers_names_flattened }} \n "
    private: no
  tasks:
    - name: Check chosen offer name exist and not emty
      fail: msg="Playbook stopped because no offer name is chosen or offer name (\"{{ offer_name_resp }}\") not declared in strategy"
      when: "{{ offer_name_resp }} not in  hostvars['localhost']['offers_name_list'] "

    - name: Register chosen  offer's name
      set_fact:
        offer_name: "{{ offer_name_resp }}"

# Ask for the new state for the chosen offer
- hosts: localhost
  any_errors_fatal: yes
  vars_prompt:
    name: "offer_status_resp"
    prompt: "Do you want to enable (yes) or to disable (no) the chosen offer ?\n Answer with ('yes'|'no') "
    private: no
  tasks:
    - name: Register chosen  offer's state
      set_fact:
        offer_status: "{{ (offer_status_resp|upper == 'YES') | ternary('ACTIVE','INACTIVE') }}"

- hosts: localhost
  roles:
    - { role: storage_offer_activation, vars: { do_action: "set_offer_status" , offer_name: "{{ offer_name }}", offer_status: '{{ offer_status }}' } }

- import_playbook: start_vitam.yml

