---

# Detect master mongodb nodes

- hosts: hosts-mongod-offer
  roles:
    - mongodb_is_master
  vars:
    - mongo_port: "{{ mongodb.mongod_port }}"

- hosts: hosts-mongoc-offer
  roles:
    - mongodb_is_master
  vars:
    - mongo_port: "{{ mongodb.mongoc_port }}"


# Stop vitam
- import_playbook: stop_vitam.yml


# Backup mongodb directory

- hosts: hosts-mongod-offer
  roles:
    - { role: backup_tape_offer, when: "( hostvars[inventory_hostname]['mongo_offer_provider'] == 'tape-library' ) and ( hostvars[inventory_hostname]['mongo_is_master'] == true )" }
  vars:
    - mongo_type: "mongod"
    - backup_dest: "{{ vitam_defaults.folder.root_path }}/tmp/mongod/{{ ansible_date_time['date'] }}-backup-mongod.zip"

- hosts: hosts-mongoc-offer
  roles:
    - { role: backup_tape_offer, when: "( hostvars[inventory_hostname]['mongo_offer_provider'] == 'tape-library' ) and ( hostvars[inventory_hostname]['mongo_is_master'] == true )" }
  vars:
    - mongo_type: "mongoc"
    - backup_dest: "{{ vitam_defaults.folder.root_path }}/tmp/mongoc/{{ ansible_date_time['date'] }}-backup-mongoc.zip"

# Post backup zip

- hosts: hosts-mongod-offer
  roles:
    - { role: send_offer_backup_to_tape, when: "( hostvars[inventory_hostname]['mongo_offer_provider'] == 'tape-library' ) and ( hostvars[inventory_hostname]['mongo_is_master'] == true )" }
  vars:
    - backup_dest: "{{ vitam_defaults.folder.root_path }}/tmp/mongod/{{ ansible_date_time['date'] }}-backup-mongod.zip"

- hosts: hosts-mongoc-offer
  roles:
    - { role: send_offer_backup_to_tape, when: "( hostvars[inventory_hostname]['mongo_offer_provider'] == 'tape-library' ) and ( hostvars[inventory_hostname]['mongo_is_master'] == true )" }
  vars:
    - backup_dest: "{{ vitam_defaults.folder.root_path }}/tmp/mongoc/{{ ansible_date_time['date'] }}-backup-mongoc.zip"


# Start vitam
- import_playbook: start_vitam.yml
