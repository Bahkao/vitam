---

# Detect master mongodb nodes

- hosts: hosts_mongod_offer
  roles:
    - tape_offer_backup_init_time_var

- hosts: hosts_mongod_offer
  roles:
    - mongodb_is_master
  vars:
    - mongo_type: "mongod"
    - mongo_port: "{{ mongodb.mongod_port }}"

- hosts: hosts_mongoc_offer
  roles:
    - mongodb_is_master
  vars:
    - mongo_type: "mongoc"
    - mongo_port: "{{ mongodb.mongoc_port }}"


# Stop vitam
- import_playbook: stop_vitam.yml

# Backup mongodb directory

- hosts: hosts_mongod_offer
  roles:
    - { role: backup_tape_offer, when: "( hostvars[inventory_hostname]['mongo_offer_provider'] == 'tape-library' ) and ( hostvars[inventory_hostname]['mongod_is_master'] == true )" }
  vars:
    - mongo_type: "mongod"
    - backup_dest: "{{ vitam_defaults.folder.root_path }}/tmp/mongod/{{ hostvars[groups['hosts_mongod_offer']|first]['tape_offer_backup_time'] }}-disk-mongod-shard{{ mongo_shard_id }}.zip"

- hosts: hosts_mongoc_offer
  roles:
    - { role: backup_tape_offer, when: "( mongo_offer_provider == 'tape-library' ) and ( mongoc_is_master == true )" }
  vars:
    - mongo_type: "mongoc"
    - backup_dest: "{{ vitam_defaults.folder.root_path }}/tmp/mongoc/{{ hostvars[groups['hosts_mongod_offer']|first]['tape_offer_backup_time'] }}-disk-mongoc-shard0.zip"

# Start mongodb
- import_playbook: start_mongodb.yml

# Start tape offer
- hosts: hosts_storage_offer_default
  any_errors_fatal: true
  roles:
    - { role: service, when: "vitam_offers[offer_conf].provider == 'tape-library'" }
  vars:
    state: "{% if 'offer' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    name: vitam-offer
    hote: "{{ ip_service }}"
    port_check: "{{ vitam.storageofferdefault.port_service }}"
    timeout: "{{ vitam_defaults.services.start_timeout }}"

# Post backup zip

- hosts: hosts_mongod_offer
  roles:
    - { role: send_offer_backup_to_tape, when: "( mongo_offer_provider == 'tape-library' ) and ( mongod_is_master == true )" }
  vars:
    - backup_dest: "{{ vitam_defaults.folder.root_path }}/tmp/mongod/{{ hostvars[groups['hosts_mongod_offer']|first]['tape_offer_backup_time'] }}-disk-mongod-shard{{ mongo_shard_id }}.zip"

- hosts: hosts_mongoc_offer
  roles:
    - { role: send_offer_backup_to_tape, when: "( mongo_offer_provider == 'tape-library' ) and ( mongoc_is_master == true )" }
  vars:
    - backup_dest: "{{ vitam_defaults.folder.root_path }}/tmp/mongoc/{{ hostvars[groups['hosts_mongod_offer']|first]['tape_offer_backup_time'] }}-disk-mongoc-shard0.zip"


# Start vitam
- import_playbook: start_vitam.yml
