---

####################################
# Début de la migration mongo data #
####################################

#########################
########## 4.2 ##########
#########################

# Arrêt du balancer

- hosts: hosts-mongos-data
  roles:
    - mongodb_balancer
  vars:
    mongo_group: hosts-mongos-data
    state: stopped

# mongoc 4.2

- hosts: hosts-mongoc-data
  roles:
    - mongodb_set_members_groups
  vars:
    mongo_group: hosts-mongoc-data
    mongo_type: mongoc
    mongo_port: "{{ mongodb.mongoc_port }}"

# Upgrade secondaries members
- hosts: hosts-mongoc-data
  roles:
    - mongodb_upgrade_package
  vars:
    mongo_group: hosts-mongoc-data
    mongo_type: mongoc
    mongo_port: "{{ mongodb.mongoc_port }}"
    mongo_version: 4.2.0-1
    mongo_primary: false
  serial: 1

# Upgrade primary member
- hosts: hosts-mongoc-data
  roles:
    - mongodb_upgrade_package
  vars:
    mongo_group: hosts-mongoc-data
    mongo_type: mongoc
    mongo_port: "{{ mongodb.mongoc_port }}"
    mongo_version: 4.2.0-1
    mongo_primary: true
  serial: 1

# mongod 4.2

- hosts: hosts-mongod-data
  roles:
    - mongodb_set_members_groups
  vars:
    mongo_group: hosts-mongod-data
    mongo_type: mongod
    mongo_port: "{{ mongodb.mongod_port }}"

- hosts: hosts-mongod-data
  roles:
    - mongodb_upgrade_package
  vars:
    mongo_group: hosts-mongod-data
    mongo_type: mongod
    mongo_port: "{{ mongodb.mongod_port }}"
    mongo_version: 4.2.0-1
    mongo_primary: false
  serial: 1

- hosts: hosts-mongod-data
  roles:
    - mongodb_upgrade_package
  vars:
    mongo_group: hosts-mongod-data
    mongo_type: mongod
    mongo_port: "{{ mongodb.mongod_port }}"
    mongo_version: 4.2.0-1
    mongo_primary: true
  serial: 1

# mongos 4.2

- hosts: hosts-mongos-data
  roles:
    - mongodb_upgrade_package
  vars:
    mongo_group: hosts-mongos-data
    mongo_type: mongos
    mongo_port: "{{ mongodb.mongos_port }}"
    mongo_version: 4.2.0-1

# Fin de la migration: redémarrage du balancer

- hosts: hosts-mongos-data
  roles:
    - mongodb_balancer
  vars:
    mongo_group: hosts-mongos-data
    state: started

# set_featurecompatibility

- hosts: hosts-mongos-data
  roles:
    - mongodb_set_feature_compatibility
  vars:
    mongo_group: hosts-mongos-data
    mongo_version: "4.2"

##################################
# Fin de la migration mongo data #
##################################

#####################################
# Début de la migration mongo offer #
#####################################

#########################
########## 4.2 ##########
#########################

# Arrêt du balancer

- hosts: hosts-mongos-offer
  roles:
    - mongodb_balancer
  vars:
    mongo_group: hosts-mongos-offer
    state: stopped

# mongoc 4.2

- hosts: hosts-mongoc-offer
  roles:
    - mongodb_set_members_groups
  vars:
    mongo_group: hosts-mongoc-offer
    mongo_type: mongoc
    mongo_port: "{{ mongodb.mongoc_port }}"

# Upgrade secondaries members
- hosts: hosts-mongoc-offer
  roles:
    - mongodb_upgrade_package
  vars:
    mongo_group: hosts-mongoc-offer
    mongo_type: mongoc
    mongo_port: "{{ mongodb.mongoc_port }}"
    mongo_version: 4.2.0-1
    mongo_primary: false
  serial: 1

# Upgrade primary member
- hosts: hosts-mongoc-offer
  roles:
    - mongodb_upgrade_package
  vars:
    mongo_group: hosts-mongoc-offer
    mongo_type: mongoc
    mongo_port: "{{ mongodb.mongoc_port }}"
    mongo_version: 4.2.0-1
    mongo_primary: true
  serial: 1

# mongod 4.2

- hosts: hosts-mongod-offer
  roles:
    - mongodb_set_members_groups
  vars:
    mongo_group: hosts-mongod-offer
    mongo_type: mongod
    mongo_port: "{{ mongodb.mongod_port }}"

- hosts: hosts-mongod-offer
  roles:
    - mongodb_upgrade_package
  vars:
    mongo_group: hosts-mongod-offer
    mongo_type: mongod
    mongo_port: "{{ mongodb.mongod_port }}"
    mongo_version: 4.2.0-1
    mongo_primary: false
  serial: 1

- hosts: hosts-mongod-offer
  roles:
    - mongodb_upgrade_package
  vars:
    mongo_group: hosts-mongod-offer
    mongo_type: mongod
    mongo_port: "{{ mongodb.mongod_port }}"
    mongo_version: 4.2.0-1
    mongo_primary: true
  serial: 1

# mongos 4.2

- hosts: hosts-mongos-offer
  roles:
    - mongodb_upgrade_package
  vars:
    mongo_group: hosts-mongos-offer
    mongo_type: mongos
    mongo_port: "{{ mongodb.mongos_port }}"
    mongo_version: 4.2.0-1

# Redémarrage du balancer

- hosts: hosts-mongos-offer
  roles:
    - mongodb_balancer
  vars:
    mongo_group: hosts-mongos-offer
    state: started

# set_featurecompatibility

- hosts: hosts-mongos-offer
  roles:
    - mongodb_set_feature_compatibility
  vars:
    mongo_group: hosts-mongos-offer
    mongo_version: "4.2"

###################################
# Fin de la migration mongo offer #
###################################
