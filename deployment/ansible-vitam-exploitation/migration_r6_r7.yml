---
# TODO : change with include_playbook stop_external.yml ; to be tested
- hosts: hosts-access-external
  roles:
    - service
  vars:
    state: stopped
    name: vitam-access-external
    hote: "{{ip_service}}"
    port_check: "{{ vitam.accessexternal.port_service }}"
    timeout: "{{ vitam_defaults.services.stop_timeout }}"

- hosts: hosts-ingest-external
  roles:
    - service
  vars:
    state: stopped
    name: vitam-ingest-external
    hote: "{{ip_service}}"
    port_check: "{{ vitam.ingestexternal.port_service }}"
    timeout: "{{ vitam_defaults.services.stop_timeout }}"

- hosts: hosts-metadata
  roles:
    - upgrade_R6_metadata

- hosts: all
  any_errors_fatal: yes
  vars_prompt:
    name: "confirmation"
    prompt: "Did metdata upgrade run successfully (please have a look at logbook logs ) ? Answer with 'YES'"
    default: "NO"
    private: no
  tasks:
    - name: Check Confirmation
      fail: msg="Playbook run confirmation failed"
      when: confirmation|upper != "YES"

- hosts: hosts-mongos-data
  roles:
    - upgrade_R6_contexts

- hosts: hosts-functional-administration
  roles:
    - upgrade_R6_reindex_ES_data

- hosts: hosts-functional-administration
  roles:
    - upgrade_R6_functionaladministration

# TODO : change with include_playbook start_external.yml ; to be tested
- hosts: hosts-ingest-external
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'siegfried' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    name: vitam-siegfried

- hosts: hosts-access-external
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'access-external' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    name: vitam-access-external
    hote: "{{ ip_service }}"
    port_check: "{{ vitam.accessexternal.port_service }}"
    timeout: "{{ vitam_defaults.services.start_timeout }}"
