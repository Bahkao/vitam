---


- name: update_cache
  shell: "yum clean all && yum makecache"

- name: Install openstack repository package
  yum:
    name: centos-release-openstack-rocky
    state: present
  register: result
  retries: "{{ packages_install_retries_number }}"
  until: result | succeeded
  delay: "{{ packages_install_retries_delay }}"

# Les différentes manières d'installer les clients openstack sont décrites ici : https://docs.openstack.org/user-guide/common/cli-install-openstack-command-line-clients.html
# KWA Note : le client designate n'est pas inclus dans les dépendances par défaut du client openstack
- name: Install openstack clients
  yum:
    name:
      - python-openstackclient
      - python-designateclient
      - python2-swiftclient
    state: present
  register: result
  retries: "{{ packages_install_retries_number }}"
  until: result | succeeded
  delay: "{{ packages_install_retries_delay }}"
  environment:
      http_proxy: "{{ http_proxy_environnement }}"
      https_proxy: "{{ http_proxy_environnement }}"
  when: http_proxy_environnement is defined and http_proxy_environnement != ""

- name: Install openstack clients
  yum:
    name:
      - python-openstackclient
      - python-designateclient
      - python2-swiftclient
    state: present
  register: result
  retries: "{{ packages_install_retries_number }}"
  until: result | succeeded
  delay: "{{ packages_install_retries_delay }}"
  when: http_proxy_environnement is not defined or http_proxy_environnement == ""

- name: Update CA truststore
  command: update-ca-trust


- name: Remove data in offer for swift with swift command
  shell: swift delete {{ vitam_prefix_offer|default(vitam_site_name) }}_{{ item[0] }}_{{ item[1] }};
  environment:
    ST_AUTH: '{{ vitam_offers[offer_conf]["swiftKeystoneAuthUrl"] }}'
    ST_USER: '{{ vitam_offers[offer_conf]["swiftDomain"] }}:{{ vitam_offers[offer_conf]["swiftUser"] }}'
    ST_KEY: '{{ vitam_offers[offer_conf]["swiftPassword"] }}'
  with_nested:
    - "{{ vitam_tenant_ids }}"
    - "{{ containerList }}"
