---
- name: set fact
  set_fact:
    cluster_ES: hosts-{{ vitam_struct.cluster_name }}

- name: Get {{ vitam_struct.cluster_name }} state
  uri:
    url: "http://{{ vitam_struct.host }}:{{ vitam_struct.port_http }}/_cluster/health?format=json"
    return_content: true
  register: ES_state
  run_once: true
  delegate_to: "{{ groups[cluster_ES][0] }}"

- name: save current state in {{ inventory_dir }}
  copy:
    content: "{{ ES_state.json }}"
    dest: "{{inventory_dir}}/troubleshoot/{{ vitam_struct.cluster_name }}.json"
  run_once: true
  delegate_to: "localhost"

- name: Get indices state
  uri:
    url: "http://{{ vitam_struct.host }}:{{ vitam_struct.port_http }}/_cat/indices?v&s=index&format=json"
    return_content: true
  register: indices_state
  run_once: true
  delegate_to: "{{ groups[cluster_ES][0] }}"

- name: save current indices state in {{ inventory_dir }}
  copy:
    content: "{{ indices_state.json }}"
    dest: "{{ inventory_dir }}/troubleshoot/{{ vitam_struct.cluster_name }}_indices.json"
  run_once: true
  delegate_to: "localhost"

- name: Get aliases state
  uri:
    url: "http://{{ vitam_struct.host }}:{{ vitam_struct.port_http }}/_cat/aliases?v&s=index&format=json"
    return_content: true
  register: aliases_state
  run_once: true
  delegate_to: "{{ groups[cluster_ES][0] }}"

- name: save current aliases state in {{ inventory_dir }}
  copy:
    content: "{{ aliases_state.json }}"
    dest: "{{inventory_dir}}/troubleshoot/{{ vitam_struct.cluster_name }}_aliases.json"
  run_once: true
  delegate_to: "localhost"


- name: Get mappings state
  uri:
    url: "http://{{ vitam_struct.host }}:{{ vitam_struct.port_http }}/*/_mapping"
    return_content: true
  register: mapping_state
  run_once: true
  delegate_to: "{{ groups[cluster_ES][0] }}"

- name: save current state in {{ inventory_dir }}
  copy:
    content: "{{ mapping_state.json }}"
    dest: "{{ inventory_dir }}/troubleshoot/{{ vitam_struct.cluster_name }}_mapping.json"
  run_once: true
  delegate_to: "localhost"
