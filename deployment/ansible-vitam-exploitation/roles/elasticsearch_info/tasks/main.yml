---
- name: set fact
  set_fact:
    cluster_ES: hosts-{{ vitam_struct.cluster_name }}

- name: Get {{ vitam_struct.cluster_name }} state
  uri:
    url: http://{{ vitam_struct.host }}:{{ vitam_struct.port_http }}/_cluster/health
    return_content: true
  register: ES_state
  run_once: true
  delegate_to: "{{ groups[cluster_ES][0] }}"

- name: save current state in {{ inventory_dir }}
  copy:
    content: "{{ ES_state }}"
    dest: "{{ inventory_dir }}/troubleshoot/{{ vitam_struct.cluster_name }}.json"
  run_once: true
  delegate_to: "localhost"

- name: ensure {{ inventory_dir }}/troubleshoot/{{ inventory_hostname }} exists to get back log & config files
  local_action:
    module: file
    path: "{{ inventory_dir }}/troubleshoot/{{ inventory_hostname }}/{{ vitam_struct.cluster_name }}"
    state: directory
    mode: 0777

# - name    : list files from {{ vitam_defaults.folder.root_path }}/log/{{ vitam_struct.vitam_component }}
#   shell   : find {{ vitam_defaults.folder.root_path }}/log/{{ vitam_struct.vitam_component }}/ -type f -mtime -2  -printf '%f\n'
#   register: path_files

- name: list files from {{ vitam_defaults.folder.root_path }}/log/{{ vitam_struct.cluster_name }}
  find:
    paths: "{{ vitam_defaults.folder.root_path }}/log/{{ vitam_struct.cluster_name }}"
    age: "-{{ age }}d"
    recurse: no # no subdir
    file_type: file
  register: path_files

- name: fetch log files from {{ vitam_struct.cluster_name }}
  fetch:
    src: "{{ item.path }}"
    dest: "{{ inventory_dir }}/troubleshoot/{{ inventory_hostname }}/{{ vitam_struct.cluster_name }}/"
    flat: yes
  with_items: "{{ path_files.files }}"


- name: fetch configuration files from {{ vitam_struct.cluster_name }}
  fetch:
    src: "{{ vitam_defaults.folder.root_path }}/conf/{{ vitam_struct.cluster_name }}/{{ item }}"
    dest: "{{ inventory_dir }}/troubleshoot/{{ inventory_hostname }}/{{ vitam_struct.cluster_name }}/"
    flat: yes
  with_items: 
    - "log4j2.properties"
    - "jvm.options"
    - "sysconfig/elasticsearch"
    - "elasticsearch.yml"