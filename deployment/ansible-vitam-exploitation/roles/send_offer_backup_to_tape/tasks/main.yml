---

- name: Detect ip_admin of tape offer
  set_fact:
    tape_offer_admin_ip: "{{ hostvars[item]['ip_admin'] }}"
  when: vitam_offers[hostvars[item]['offer_conf']]['provider'] == 'tape-library'
  with_inventory_hostnames:
    - hosts-storage-offer-default

- name: Post backup to tape offer
  uri:
    url: "http://{{ tape_offer_admin_ip }}:{{ vitam.storageofferdefault.port_admin }}/offer/v1/backup"
    method: POST
    headers:
      Connection: "keep-alive"
      X-Tenant-Id: "{{ vitam_tenant_admin }}"
      Content-Type: "application/octet-stream"
    src: "{{ backup_dest }}"
    remote_src: yes
    body_format: "raw"
    # TODO: define correct timeout value
    timeout: "{{ vitam_defaults.services.api_call_timeout }}"
    status_code: 201
  register: upload_result
  until: upload_result.status != -1
  retries: 1
  delay: 10
