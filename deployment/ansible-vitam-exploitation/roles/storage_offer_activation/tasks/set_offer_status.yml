---

- name: Compute chosen offer new state (activate|disactivate)
  set_fact:
    vitam_strategy_combined_item: "{{ item |combine({'name': offer_name ,'status': offer_status}) }}"
  with_items: "{{ vitam_strategy }}"
  when: " {{ ('\"' + item.name + '\"') is  match(offer_name) }}"

- name: Retrieve strategy's unchanged items
  set_fact:
    vitam_strategy_unchanged_items : "{{ vitam_strategy_unchanged_items|default([]) | union([item]) }}"
  with_items: "{{ vitam_strategy }}"
  when: " {{ ('\"' + item.name + '\"') is not match(vitam_strategy_combined_item.name) }}"

- name: Merge items (changed and unchanged)
  set_fact:
    vitam_strategy_combined: "{{ vitam_strategy_unchanged_items|default([]) | union ([ vitam_strategy_combined_item]) | unique }}"

- name: Write the updated vitam_strategy to a YAML file
  template:
    src: "offers_opts.yml.j2"
    dest: "{{ inventory_dir }}/group_vars/all/offers_opts.yml"
