---
- name: Ensure service is started
  service:
    name: "vitam-functional-administration"
    state: started

- name: "Wait until service functional-admin is up"
  wait_for:
      host: "{{hostvars[groups['hosts-functional-administration'][0]]['ip_admin']}}"
      port: "{{vitam.functional_administration.port_admin}}"
      state: "started"
      timeout: "{{ vitam_defaults.services.start_timeout }}"
  run_once: true

- name: Check if admin context exists
  uri:
    method: GET
    body: "{ \"$query\":{\"$eq\":{\"Name\":\"admin-context\"}},\"$filter\":{\"$limit\": 1},\"$projection\":{} }"
    status_code: 200
    url: "http://{{hostvars[groups['hosts-functional-administration'][0]]['ip_admin']}}:{{vitam.functional_administration.port_admin}}/v1/admin/contexts"
    body_format: "json"
  run_once: true
  register: context_check

- name: Modify json & convert to dict...
  set_fact:
    context_check: "{{ context_check.json |regex_replace('\\$results', 'results') }}"
  run_once: true

- name: update context to functionnal-admin
  uri:
    method: PUT
    body: "{\"$action\": [{\"$set\": {\"LastUpdate\": \"{{ lookup('pipe', 'date +%Y-%m-%d-%H-%M-%S')}}\"}}]}"
    status_code: 200,201
    url: "http://{{hostvars[groups['hosts-functional-administration'][0]]['ip_admin']}}:{{vitam.functional_administration.port_admin}}/v1/admin/contexts/{{context_check.results[0].Identifier}}
    body_format: "json"
    headers:
      X-Tenant-Id: "{{ vitam_tenant_admin }}"
  run_once: true
  register: functional_adm_response
