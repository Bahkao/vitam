---

### HOSTS NETWORK VARS CHECK ###
- hosts: hosts
  any_errors_fatal: true
  roles:
    - check_networks

# consul start
- hosts: hosts-consul-server
  any_errors_fatal: true
  serial: 1
  roles:
    - service
  vars:
    state: "{% if 'consul' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    name: vitam-consul

# consul start
- hosts: vitam
  roles:
    - service
  vars:
    state: started
    name: vitam-consul

# log-central start
- hosts: hosts-elasticsearch-log
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'elasticsearch-log' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    name: vitam-elasticsearch-log
    host: "{{ ip_admin }}"
    port_check: "{{ elasticsearch.log.port_tcp }}"
    timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts-logstash
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'logstash' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    name: logstash
    host: "{{ ip_admin }}"
    port_check: "{{ logstash.port }}"
    timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts-kibana-log
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'kibana' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    name: kibana
    host: "{{ ip_service }}"
    port_check: "{{ kibana.log.port }}"
    timeout: "{{ vitam_defaults.services.start_timeout }}"

# Databases start
- hosts: hosts-mongoc-data
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'mongoc' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    name: vitam-mongoc
    host: "{{ ip_service }}"
    port_check: "{{ mongodb.mongoc_port }}"
    timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts-mongod-data
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'mongod' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    name: vitam-mongod
    host: "{{ ip_service }}"
    port_check: "{{ mongodb.mongod_port }}"
    timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts-mongos-data
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: started
    name: vitam-mongos
    host: "{{ ip_service }}"
    port_check: "{{ mongodb.mongos_port }}"
    timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts-mongoc-offer
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: started
    name: vitam-mongoc
    host: "{{ ip_service }}"
    port_check: "{{ mongodb.mongoc_port }}"
    timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts-mongod-offer
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: started
    name: vitam-mongod
    host: "{{ ip_service }}"
    port_check: "{{ mongodb.mongod_port }}"
    timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts-mongos-offer
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: started
    name: vitam-mongos
    host: "{{ ip_service }}"
    port_check: "{{ mongodb.mongos_port }}"
    timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts-elasticsearch-data
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'elasticsearch-data' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    name: vitam-elasticsearch-data
    host: "{{ ip_service }}"
    port_check: "{{ elasticsearch.data.port_tcp }}"
    timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts-cerebro
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'cerebro' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    name: vitam-elasticsearch-cerebro
    host: "{{ ip_service }}"
    port_check: "{{cerebro.port}}"
    timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts-kibana-data
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'kibana' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    name: kibana
    host: "{{ ip_service }}"
    port_check: "{{ kibana.data.port }}"
    timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts-storage-offer-default
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'offer' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    name: vitam-offer
    #vitam_struct: "{{ vitam.storageofferdefault }}"
    host: "{{ ip_service }}"
    port_check: "{{ vitam.storageofferdefault.port_service }}"
    timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts-storage-engine
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'storage' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    vitam_struct: "{{ vitam.storageengine }}"
    name: vitam-storage
    host: "{{ ip_service }}"
    port_check: "{{ vitam.storageengine.port_service }}"
    timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts-metadata
  serial: 1
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'metadata' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    name: vitam-metadata
    host: "{{ ip_service }}"
    port_check: "{{ vitam.metadata.port_service }}"
    timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts-workspace
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'workspace' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    name: vitam-workspace
    host: "{{ ip_service }}"
    port_check: "{{ vitam.workspace.port_service }}"
    timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts-logbook
  serial: 1
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'logbook' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    name: vitam-logbook
    host: "{{ ip_service }}"
    port_check: "{{ vitam.logbook.port_service }}"
    timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts-functional-administration
  serial: 1
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'functional-administration' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    name: vitam-functional-administration
    host: "{{ ip_service }}"
    port_check: "{{ vitam.functional_administration.port_service }}"
    timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts-security-internal
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'security-internal' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    name: vitam-security-internal
    host: "{{ ip_service }}"
    port_check: "{{ vitam.security_internal.port_service }}"
    timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts-processing
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'processing' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    name: vitam-processing
    host: "{{ ip_service }}"
    port_check: "{{ vitam.processing.port_service }}"
    timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts-worker
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'siegfried' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    name: vitam-siegfried

- hosts: hosts-worker
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'worker' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    name: vitam-worker
    host: "{{ ip_service }}"
    port_check: "{{ vitam.worker.port_service }}"
    timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts-access-internal
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'access-internal' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    name: vitam-access-internal
    host: "{{ ip_service }}"
    port_check: "{{ vitam.accessinternal.port_service }}"
    timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts-access-external
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'access-external' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    name: vitam-access-external
    host: "{{ ip_service }}"
    port_check: "{{ vitam.accessexternal.port_service }}"
    timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts-ingest-internal
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'ingest-internal' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    name: vitam-ingest-internal
    host: "{{ ip_service }}"
    port_check: "{{ vitam.ingestinternal.port_service }}"
    timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts-ingest-external
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'siegfried' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    name: vitam-siegfried

- hosts: hosts-ingest-external
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'ingest-external' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    name: vitam-ingest-external
    host: "{{ ip_service }}"
    port_check: "{{ vitam.ingestexternal.port_service }}"
    timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts-ihm-demo
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'ihm-demo' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    name: vitam-ihm-demo
    host: "{{ ip_service }}"
    port_check: "{{vitam.ihm_demo.port_service}}"
    timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: hosts-ihm-recette
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'ihm-recette' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    name: vitam-ihm-recette
    host: "{{ ip_service }}"
    port_check: "{{vitam.ihm_recette.port_service}}"
    timeout: "{{ vitam_defaults.services.start_timeout }}"

- hosts: library
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'library' not in vitam_secondary_site_components and primary_site| lower == 'false' %}stopped{% else %}started{% endif %}"
    name: vitam-library
    host: "{{ ip_service }}"
    port_check: "{{vitam.library.port_service}}"
    timeout: "{{ vitam_defaults.services.start_timeout }}"

############################
# Primary site timers
############################

- hosts: hosts-logbook
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'vitam-traceability-lfc-unit.timer' not in vitam_secondary_site_components and primary_site| lower == 'true' and inventory_hostname == groups['hosts-logbook'] | last %}started{% else %}stopped{% endif %}"
    name: vitam-traceability-lfc-unit.timer

- hosts: hosts-logbook
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'vitam-traceability-lfc-objectgroup.timer' not in vitam_secondary_site_components and primary_site| lower == 'true' and inventory_hostname == groups['hosts-logbook'] | last %}started{% else %}stopped{% endif %}"
    name: vitam-traceability-lfc-objectgroup.timer


- hosts: hosts-logbook
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'vitam-traceability-operations.timer' not in vitam_secondary_site_components and primary_site| lower == 'true' and inventory_hostname == groups['hosts-logbook'] | last %}started{% else %}stopped{% endif %}"
    name: vitam-traceability-operations.timer

- hosts: hosts-logbook
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'vitam-traceability-audit.timer' not in vitam_secondary_site_components and primary_site| lower == 'true' and inventory_hostname == groups['hosts-logbook'] | last %}started{% else %}stopped{% endif %}"
    name: vitam-traceability-audit.timer

- hosts: hosts-functional-administration
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'vitam-rule-management-audit.timer' not in vitam_secondary_site_components and primary_site| lower == 'true' and inventory_hostname == groups['hosts-functional-administration'] | last %}started{% else %}stopped{% endif %}"
    name: vitam-rule-management-audit.timer

- hosts: hosts-storage-engine
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'vitam-storage-log-traceability.timer' not in vitam_secondary_site_components and primary_site| lower == 'true' %}started{% else %}stopped{% endif %}"
    name: vitam-storage-log-traceability.timer

- hosts: hosts-storage-engine
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'vitam-storage-log-backup.timer' not in vitam_secondary_site_components and primary_site| lower == 'true' and inventory_hostname == groups['hosts-storage-engine'] | last %}started{% else %}stopped{% endif %}"
    name: vitam-storage-log-backup.timer

#########################################
# Secondary site timers (reconstruction)
#########################################

- hosts: hosts-metadata
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'vitam-metadata-reconstruction.timer' in vitam_secondary_site_components and primary_site| lower == 'false' and inventory_hostname == groups['hosts-metadata'] | last %}started{% else %}stopped{% endif %}"
    name: vitam-metadata-reconstruction.timer

- hosts: hosts-logbook
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'vitam-logbook-reconstruction.timer' in vitam_secondary_site_components and primary_site| lower == 'false' and inventory_hostname == groups['hosts-logbook'] | last %}started{% else %}stopped{% endif %}"
    name: vitam-logbook-reconstruction.timer

- hosts: hosts-functional-administration
  any_errors_fatal: true
  roles:
    - service
  vars:
    state: "{% if 'vitam-functional-administration-reconstruction.timer' in vitam_secondary_site_components and primary_site| lower == 'false' and inventory_hostname == groups['hosts-functional-administration'] | last %}started{% else %}stopped{% endif %}"
    name: vitam-functional-administration-reconstruction.timer
