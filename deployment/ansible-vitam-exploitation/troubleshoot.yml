---

# Confirm launching this playbook
- hosts: all
  any_errors_fatal: yes
  vars_prompt:
    name: "confirmation"
    prompt: "Are you sure you want to run this playbook? Answer with 'YES'"
    default: "NO"
    private: no

  tasks:
    - name: Check Confirmation
      fail: msg="Playbook run confirmation failed"
      when: confirmation|upper != "YES"

# Init troubleshoot
- hosts: hosts
  roles:
    - init_troubleshoot
    - gather_host
    - resolvconf
    - tree_deployment

# get consul state
- hosts: hosts-consul-server
  roles:
    - consul_state

# fetch logs
- hosts: hosts-storage-offer-default
  roles:
    - vitam_log_files
  vars:
    vitam_struct: "{{ vitam.storageofferdefault }}"

- hosts: hosts-storage-engine
  any_errors_fatal: true
  roles:
    - vitam_log_files
  vars:
    vitam_struct: "{{ vitam.storageengine }}"

- hosts: hosts-metadata
  any_errors_fatal: true
  serial: 1
  roles:
    - vitam_log_files
  vars:
    vitam_struct: "{{ vitam.metadata }}"

- hosts: hosts-logbook
  any_errors_fatal: true
  serial: 1
  roles:
    - vitam_log_files
  vars:
    vitam_struct: "{{ vitam.logbook }}"

- hosts: hosts-workspace
  any_errors_fatal: true
  roles:
    - vitam_log_files
  vars:
    vitam_struct: "{{ vitam.workspace }}"

- hosts: hosts-functional-administration
  any_errors_fatal: true
  serial: 1
  roles:
    - vitam_log_files
  vars:
    vitam_struct: "{{ vitam.functional_administration }}"

- hosts: hosts-security-internal
  any_errors_fatal: true
  roles:
    - vitam_log_files
  vars:
    vitam_struct: "{{ vitam.security_internal }}"

- hosts: hosts-processing
  any_errors_fatal: true
  roles:
    - vitam_log_files
  vars:
    vitam_struct: "{{ vitam.processing }}"

- hosts: hosts-worker
  any_errors_fatal: true
  roles:
    - vitam_log_files
  vars:
    vitam_struct: "{{ vitam.worker }}"

- hosts: hosts-access-internal
  any_errors_fatal: true
  roles:
    - vitam_log_files
  vars:
    vitam_struct: "{{ vitam.accessinternal }}"

- hosts: hosts-access-external
  any_errors_fatal: true
  roles:
    - vitam_log_files
  vars:
    vitam_struct: "{{ vitam.accessexternal }}"

- hosts: hosts-ingest-internal
  any_errors_fatal: true
  roles:
    - vitam_log_files
  vars:
    vitam_struct: "{{ vitam.ingestinternal }}"

- hosts: hosts-ingest-external
  any_errors_fatal: true
  roles:
    - vitam_log_files
   #- {role: clamav, when: vitam_struct.antivirus=='clamav' }
  vars:
    vitam_struct: "{{ vitam.ingestexternal }}"

- hosts: hosts-ihm-demo
  any_errors_fatal: true
  roles:
    - vitam_log_files
  vars:
    vitam_struct: "{{ vitam.ihm_demo }}"

# Get elasticsearch info
- hosts: hosts-elasticsearch-log
  roles:
    - elasticsearch_info
  vars:
    vitam_struct: "{{ elasticsearch.log }}"

- hosts: hosts-elasticsearch-data
  roles:
    - elasticsearch_info
  vars:
    vitam_struct: "{{ elasticsearch.data }}"

- hosts: all
  any_errors_fatal: yes
  vars_prompt:
    name: "get_crt"
    prompt: "Can we copy your crt files (YES/NO) ?"
    default: "NO"
    private: no
  roles:
    - {role: get_crt_files, when: get_crt|upper == "YES"}

- hosts: hosts
  roles:
    - end
