---

- name: apply configuration files for curator
  template:
    src: "{{ item }}.j2"
    dest: "{{curator_conf_dir}}/{{ item }}"
    owner: "{{ vitam_defaults.users.vitam }}"
    group: "{{ vitam_defaults.users.group }}"
    mode: "{{ vitam_defaults.folder.conf_permission }}"
  with_items:
    - "delete_index_metricbeat.yml"
    - "delete_index_packetbeat.yml"


- name: copy the systemd unit & timer files for curator on CentOS environment
  template:
    src: "{{ role_path }}/templates/systemd/{{ item }}.j2"
    dest: "/usr/lib/systemd/system/{{ item }}"
  with_items: "{{ lookup('pipe','find {{ role_path }}/templates/systemd/ -type f  -exec basename {} .j2 \\; || true').split('\n') }}"
  when:
    - ansible_distribution == 'CentOS'
    - "{{ lookup('pipe', 'test -d {{ role_path }}/templates/systemd || echo nofolder') == \"\" }}"

- name: copy the systemd unit & timer files for curator on Debian environment
  template:
    src: "{{ role_path }}/templates/systemd/{{ item }}.j2"
    dest: "/lib/systemd/system/{{ item }}"
  with_items: "{{ lookup('pipe','find {{ role_path }}/templates/systemd/ -type f  -exec basename {} .j2 \\; || true').split('\n') }}"
  when:
    - ansible_distribution == 'Debian'
    - "{{ lookup('pipe', 'test -d {{ role_path }}/templates/systemd || echo nofolder') == \"\" }}"

- name: Enable systemd timers
  systemd:
    name: "{{ item }}"
    daemon_reload: "yes"
    enabled: "yes"
    state: "started"
  with_items: "{{ lookup('pipe','find {{ role_path }}/templates/systemd/ -type f -name *.timer.j2 -exec basename {} .j2 \\; || true').split('\n') }}"
  when:
    - "{{ lookup('pipe', 'test -d {{ role_path }}/templates/systemd || echo nofolder') == \"\" }}"
