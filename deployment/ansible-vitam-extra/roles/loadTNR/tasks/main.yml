---
# tasks file for loadTNR
- name: ensure TNR output doesn't exist
  file:
    path: "{{TNR_output}}"
    state: absent

- name: Purge database collections before launching TNR
  uri:
    method: DELETE
    HEADER_X-Tenant-Id: 0
    url: "http://{{vitam_ihm_recette_host}}:{{vitam_ihm_recette_port}}/{{item}}"
  with_items:
    - "/ihm-recette/v1/api/delete/logbook/operation"
    - "/ihm-recette/v1/api/delete/masterdata/accessContract"
    - "/ihm-recette/v1/api/delete/masterdata/ingestContract"
    - "/ihm-recette/v1/api/delete/logbook/lifecycle/unit"
    - "/ihm-recette/v1/api/delete/logbook/lifecycle/objectgroup"
    - "/ihm-recette/v1/api/delete/metadata/objectgroup"
    - "/ihm-recette/v1/api/delete/metadata/unit"
    - "/ihm-recette/v1/api/delete/accessionregisters"

- name: launch TNR
#  shell: java -Dlogback.configurationFile="{{TNR_conf}}/logback.xml" -DtnrBaseDirectory={{ TNR_dir }} -jar {{TNR_lib}}/functional-test-*-jar-with-dependencies.jar -g fr.gouv.vitam.functionaltest.cucumber -p junit:{{ TNR_output }} {{ TNR_dir }}
  shell: java -Dlogback.configurationFile="{{TNR_conf}}/logback.xml" -DtnrBaseDirectory={{ TNR_dir }} -jar {{TNR_lib}}/functional-test-*.jar -g fr.gouv.vitam.functionaltest.cucumber -p junit:{{ TNR_output }} -p fr.gouv.vitam.functionaltest.cucumber.report.VitamReporter:{{report_dir}}/report_{{ansible_date_time.year}}{{ansible_date_time.month}}{{ ansible_date_time.day}}_{{ ansible_date_time.hour}}{{ ansible_date_time.minute}}{{ ansible_date_time.second}}.json {{ TNR_dir }}
  become_user: "{{ vitam_user }}"
  ignore_errors: true
  args:
    chdir: "{{TNR_conf}}"

- name: get back TNR output file {{TNR_output}}
  fetch:
    src: "{{ TNR_output }}"
    dest: "{{inventory_dir}}/"
    flat: yes
  ignore_errors: true
