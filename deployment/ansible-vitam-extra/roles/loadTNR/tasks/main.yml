---
# tasks file for loadTNR
- name: ensure TNR output doesn't exist
  file:
    path: "{{TNR_output}}"
    state: absent

#- name: test
#  uri:
#    method: GET
#    # body: '{"token":{"principal":"aadmin","credentials":"aadmin1234"}}'
#    # headers:
#    #  Content-Type: "application/json"
#    url: http://{{vitam_ihm_recette_host}}:{{vitam_ihm_recette_port}}/ihm-recette/core/filter/replace.filter.js
#  register: login
#  ignore_errors: true

#- name: test2
#  uri:
#    method: POST
#    body: '{"token":{"principal":"aadmin","credentials":"aadmin1234"}}'
#    headers:
#      Content-Type: "application/json"
#      Cookie: "{{login.Set-Cookie}}"
#    url: http://{{vitam_ihm_recette_host}}:{{vitam_ihm_recette_port}}/ihm-recette/v1/api/login
#  ignore_errors: true

# Authent with curl as we have a problem to get the Set-Cookie header with uri module
# "-" is forbidden in variables names
- name: ihm-recette auth with curl
  shell: "curl -s -v -H 'Content-Type: application/json' --data '{\"token\":{\"principal\":\"aadmin\",\"credentials\":\"aadmin1234\"} }' http://{{vitam_ihm_recette_host}}:{{vitam_ihm_recette_port}}/ihm-recette/v1/api/login 2>&1 |grep Set-Cookie |awk -F \"Set-Cookie: \" '{print $2}' | tr '\\r\\n' '; '"
  register: login

- name: Purge database collections before launching TNR
  uri:
    method: DELETE
    headers:
      X-Tenant-Id: "0"
      Cookie: "{{login.stdout}}"
    url: "http://{{vitam_ihm_recette_host}}:{{vitam_ihm_recette_port}}/{{item}}"
  with_items:
    - "ihm-recette/v1/api/delete/logbook/operation"
    - "ihm-recette/v1/api/delete/masterdata/accessContract"
    - "ihm-recette/v1/api/delete/masterdata/ingestContract"
    - "ihm-recette/v1/api/delete/logbook/lifecycle/unit"
    - "ihm-recette/v1/api/delete/logbook/lifecycle/objectgroup"
    - "ihm-recette/v1/api/delete/metadata/objectgroup"
    - "ihm-recette/v1/api/delete/metadata/unit"
    - "ihm-recette/v1/api/delete/accessionregisters"
  ignore_errors: true


- name: launch TNR
#  shell: java -Dlogback.configurationFile="{{TNR_conf}}/logback.xml" -DtnrBaseDirectory={{ TNR_dir }} -jar {{TNR_lib}}/functional-test-*-jar-with-dependencies.jar -g fr.gouv.vitam.functionaltest.cucumber -p junit:{{ TNR_output }} {{ TNR_dir }}
  shell: java -Dlogback.configurationFile="{{TNR_conf}}/logback.xml" -DtnrBaseDirectory={{ TNR_dir }} -jar {{TNR_lib}}/functional-test-*.jar -g fr.gouv.vitam.functionaltest.cucumber -p junit:{{ TNR_output }} -p fr.gouv.vitam.functionaltest.cucumber.report.VitamReporter:{{report_dir}}/report_{{ansible_date_time.year}}{{ansible_date_time.month}}{{ ansible_date_time.day}}_{{ ansible_date_time.hour}}{{ ansible_date_time.minute}}{{ ansible_date_time.second}}.json {{ TNR_dir }}
  become_user: "{{ vitam_user }}"
  ignore_errors: true
  args:
    chdir: "{{TNR_conf}}"

- name: get back TNR output file {{TNR_output}}
  fetch:
    src: "{{ TNR_output }}"
    dest: "{{inventory_dir}}/"
    flat: yes
  ignore_errors: true
