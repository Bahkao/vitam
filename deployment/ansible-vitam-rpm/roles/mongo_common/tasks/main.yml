---

- name: Install mongodb-org rpm
  yum:
    name: mongodb-org
    state: present
    update_cache: yes

- name: install vitam-user-vitamdb
  yum:
    name: vitam-user-vitamdb
    state: latest
    update_cache: yes

- name: add syslog option
  replace:
    dest: /etc/sysconfig/mongod
    regexp: '^# OPTIONS=.*$'
    replace: 'OPTIONS=" -f /etc/mongod.conf --syslog "'

# next steps in order to disable Transparent HugePages
# cf https://docs.mongodb.com/manual/tutorial/transparent-huge-pages/

- name: Install tuned rpm
  yum:
    name: tuned
    state: present

- name: create the tuned conf directory
  file:
    path: "/etc/tuned/no-thp"
    state: directory
    owner: root
    mode: 0640

- name: add the tuned conf file
  copy:
    src: tuned.conf
    dest: /etc/tuned/no-thp/tuned.conf
    owner: root
    mode: 0640

- name: enable the new tuned profile
  command: tuned-adm profile no-thp
  become: true
  become_user: root

- name: restart tuned
  service:
    name: tuned
    state: started

- name: add systemd service unit to disable THP
  copy:
    src: disable_transparent_hugepages.service
    dest: /usr/lib/systemd/system/disable_transparent_hugepages.service
    owner: root
    mode: 0700

- name: enable systemd service unit to disable THP
  service:
    name: disable_transparent_hugepages.service
    enabled: yes
    state: started
