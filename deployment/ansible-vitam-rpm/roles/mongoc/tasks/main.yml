---

- name: Install mongo rpm
  yum:
    name: vitam-mongoc
    state: present

- name: Check that the directories exists (must be removed when the RPM plugin will be patched)
  file:
    path: "{{ vitam_folder_root }}/{{ item }}/mongoc"
    state: directory
    owner: "{{ mongo_user}}"
    group: "{{vitam_group}}"
    mode: "{{vitam_folder_permission}}"
  with_items:
    - app
    - bin
    - conf
    - data
    - lib
    - log
    - script
    - tmp

- name: create db sub-directory
  file:
    path: "{{ mongoc_folder_database }}"
    owner: "{{mongo_user}}"
    group: "{{vitam_group}}"
    state: directory
    mode: "{{vitam_folder_permission}}"

- name: Create the mongoc configuration server file
  template:
    src: "mongoc.conf.j2"
    dest: "{{mongo_config_path}}/mongoc.conf"
    owner: "{{mongo_user}}"
    mode: "{{vitam_conf_permission}}"

- name: restart mongoc
  service:
    name: vitam-mongoc
    enabled: true
    state: restarted

# Enable mongo passphrase

- name: Copy the passphrase
  template:
    src: "keyfile.j2"
    dest: "{{ mongo_config_path }}/keyfile"
    owner: "{{ mongo_user}}"
    mode: 0600

# Now lest's initiate the replica set (do this only on the last node)

- name: Wait for the service port to be open
  wait_for: port={{mongoc_port}} timeout=10
  when: inventory_hostname == "{{ groups['mongoc']|last }}"

- name: Copy the script which initiate the replica set
  template:
    src: "init-replica.js.j2"
    dest: "{{vitam_folder_root}}/tmp/init-replica-config.js"
    owner: "{{mongo_user}}"
    mode: "{{vitam_conf_permission}}"
  when: inventory_hostname == "{{ groups['mongoc']|last }}"

- name: Initiate the replica set
  command: mongo --port {{mongoc_port}} {{vitam_folder_root}}/tmp/init-replica-config.js
  when: inventory_hostname == "{{ groups['mongoc']|last }}"

- name: Delete the init-replica.js file
  file:
    dest: "{{vitam_folder_root}}/tmp/init-replica.js"
    state: "absent"
  when: inventory_hostname == "{{ groups['mongoc']|last }}"

# Consul

- name: Ensure consul config dir is OK
  file:
    path: "{{consul_folder_conf}}"
    state: directory
    owner: "{{vitam_user}}"
    group: "{{vitam_group}}"

# KWA : a fixer ASAP !
- name: Deploy consul agent service declaration
  template:
    src: "service-componentid.json.j2"
    dest: "{{consul_folder_conf}}/service-mongoc.json"
    owner: "{{vitam_user}}"
    group: "{{vitam_group}}"
    mode: "{{vitam_conf_permission}}"

- name: reload consul agent configuration
  service:
    name: vitam-consul
    state: reloaded
