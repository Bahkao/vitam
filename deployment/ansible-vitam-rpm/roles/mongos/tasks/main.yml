---

- name: Install mongo rpm
  yum:
    name: vitam-mongos
    state: present

- name: Check that the directories exists (must be removed when the RPM plugin will be patched)
  file:
    path: "{{vitam_folder_root}}/{{ item }}/mongos"
    state: directory
    owner: "{{ mongo_user}}"
    group: 2000
    mode: 0750
  with_items:
    - app
    - bin
    - conf
    - data
    - lib
    - log
    - script
    - tmp

- name: Create the mongos configuration server file
  template: src=mongos.conf.j2 dest={{mongo_config_path}}/mongos.conf

- name: restart mongos
  service:
    name: vitam-mongos
    enabled: true
    state: restarted

# Enable mongo passphrase

- name: Copy the passphrase
  template:
    src: "keyfile.j2"
    dest: "{{ mongo_config_path }}/keyfile"
    owner: "{{ mongo_user}}"
    mode: 0600

# Consul

- name: Ensure consul config dir is OK
  file:
    path: "{{vitam_folder_root}}/conf/consul"
    state: directory
    owner: "vitam"
    group: "vitam"

# KWA : a fixer ASAP !
- name: Deploy consul agent service declaration
  template:
    src: "service-componentid.json.j2"
    dest: "{{vitam_folder_root}}/conf/consul/service-mongos.json"
    owner: "vitam"
    group: "vitam"
    mode: "{{vitam_conf_permission}}"

- name: reload consul agent configuration
  service:
    name: vitam-consul
    state: reloaded
