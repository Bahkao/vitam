---
- name: Install rpm {{ rpm_name }}
  yum: 
    name: "{{ rpm_name }}-{{rpm_version}}"
    state: latest
    update_cache: yes
# OMA : question : lastest ou fixer la version dans les fichiers d'inventaire ???

- name: Check that the directories exists (must be removed when the RPM plugin will be patched)
  file: 
    path: "{{vitam_folder_root}}/{{ item }}/{{ vitam_component }}"
    state: directory
    owner: "{{ vitam_user}}"
    group: "{{ vitam_group }}"
    mode: "0750"
    recurse: yes # Added if someone uses root...
  with_items:
    - app
    - bin
    - conf
    - data
    - lib
    - log
    - script
    - tmp


- name: Deploy common configuration files
  template:
    src: "{{item}}.j2"
    dest: "{{vitam_folder_conf}}/{{item}}"
    owner: "{{ vitam_user}}"
    group: "{{ vitam_group }}"
    mode: "{{vitam_conf_permission}}"
  with_items:
    - "logbook-client.conf"
    - "server-identity.conf"
    - "logback.xml"
    - "logback-access.xml"
    - "antisamy-esapi.xml"
    - "jetty-config.xml"


- name: Deploy common configuration files in sysconfig subdir
  template:
    src: "{{item}}.j2"
    dest: "{{vitam_folder_conf}}/sysconfig/{{item}}"
    owner: "{{ vitam_user}}"
    group: "{{ vitam_group }}"
    mode: "{{vitam_conf_permission}}"
  with_items:
    - "java_opts"

# KWA : a fixer ASAP !
- name: Ensure consul config dir is OK
  file:
    path: "{{vitam_folder_root}}/conf/consul"
    state: directory
    owner: "{{ vitam_user }}"
    group: "{{ vitam_group }}"

# KWA : a fixer ASAP !
- name: Deploy consul agent service declaration
  template:
    src: "service-componentid.json.j2"
    dest: "{{vitam_folder_root}}/conf/consul/service-{{ vitam_component }}.json"
    owner: "{{ vitam_user }}"
    group: "{{ vitam_group }}"
    mode: "{{vitam_conf_permission}}"

- name: reload consul agent configuration
  service:
    name: vitam-consul
    state: reloaded
  notify:
   - restart consul


- name: Deploy specific configuration files (can override the common configuration files)
  template:
    src: "{{role_path}}/templates/{{ vitam_component }}/{{item}}.j2"
    dest: "{{vitam_folder_conf}}/{{item }}"
    owner: "{{ vitam_user }}"
    group: "{{ vitam_group }}"
    mode: "{{vitam_conf_permission}}"
  with_items: "{{ lookup('pipe','find {{role_path}}/templates/{{ vitam_component }}/ -type f  -exec basename {} .j2 \\;').split('\n') }}"
  no_log: true # OMA test as there may be secrets in verbose output

# OMA : disabled as now template due to directories changes
# - name: Install systemd wrapper.sh (must be included in the RPM)
#   copy: 
#     src: wrapper.sh
#     dest: "/vitam/bin/{{ vitam_component }}/wrapper.sh"
#     owner: "{{ vitam_user}}"
#     group: "{{ vitam_group }}"
#     mode: "0750"

# - name: Check that the directories exists (must be removed when the RPM plugin will be patched)
#   file: 
#     path: "/vitam/{{ vitam_component }}/{{ item }}"
#     state: directory
#     owner: "{{ vitam_user}}"
#     group: "{{ vitam_group }}"
#     mode: "0750"
#     recurse: yes # Added if someone uses root...
#   with_items:
#     - app
#     - bin
#     - conf
#     - lib
#     - log 
#     - data
#     - tmp

- name: copy files section 
  copy:
    src: "{{role_path}}/files/{{ vitam_component }}/{{item}}"
    dest: "{{vitam_folder_conf}}/{{item }}"
    owner: "{{ vitam_user }}"
    group: "{{ vitam_group }}"
    mode: "{{vitam_conf_permission}}"
  with_items: "{{ lookup('pipe','find {{role_path}}/files/{{ vitam_component }}/ -type f -exec basename {} \\;').split('\n') }}"

# OMA: disabled as hooks are now integrated for postinst, preun && postun in pom.xml
# - name: systemctl reload-daemon
#   command: systemctl daemon-reload

- name: (re)-start service
  service: 
    name: "vitam-{{ vitam_component }}"
    enabled: true
    state: restarted
