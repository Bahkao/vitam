---
#(user vitam / groupe vitam)
- name: Ensure VITAM directories exist to persist VITAM data, configuration and logs
  file: 
    name={{item}} 
    state=directory
    owner={{local_user}}
    group=vitam
    mode={{vitam_folder_permission}}
  with_items:
  - "{{vitam_folder_conf}}"
  - "{{vitam_folder_log}}"
  - "{{vitam_folder_data}}"

- name: Deploy configuration files
  template:
    src="{{item}}.j2"
    dest="{{vitam_folder_conf}}/{{item}}"
    owner={{local_user}}
    group=vitam mode={{vitam_conf_permission}}
  notify: restart container
  with_items:
  - "logbook-client.conf"
  - "server-identity.conf"
  - "setenv.sh"
  - "logback.xml"
  - "functional-administration.conf"
  - "antisamy-esapi.xml"

- name: Deploy VITAM docker file
  docker:
    name: "{{vitam_docker_name}}"
    image: "{{docker_registry_hostname}}/vitam/{{vitam_component}}:{{vitam_docker_tag}}"
    state: started
    restart_policy: always
    pull: "{{pull_strategy}}"
    ports:
      - "{{vitam_docker_port_http}}:{{vitam_docker_port_internal}}"
    volumes: 
      - "{{vitam_folder_conf}}:/vitam/conf"
      - "{{vitam_folder_log}}:/vitam/log"
      - "{{vitam_folder_data}}:/vitam/data"
