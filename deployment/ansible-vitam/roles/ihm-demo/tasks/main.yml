---
#(user vitam / groupe vitam)
- name: Ensure VITAM directories exist to persist VITAM data, configuration and logs
  file: 
    name={{item}} 
    state=directory
    owner=vitam
    group=vitam
    mode=0755
  with_items:
  - "{{vitam_folder_conf}}"
  - "{{vitam_folder_log}}"
  - "{{vitam_folder_data}}"
  - "{{vitam_conf_ingest_web}}"
  - "{{vitam_data_ingest_web}}"
  - "{{vitam_log_ingest_web}}"

- name: Deploy configuration files
  template:
    src="{{item}}.j2"
    dest="{{vitam_conf_ingest_web}}/{{item}}"
    owner=vitam
    group=vitam mode=0500
  notify: restart container
  with_items:
  - "ingest-web.properties"
  - "logbook-client.conf"
  - "server-identity.conf"
  - "setenv.sh"
  - "logback.xml"

- name: Deploy VITAM docker file
  docker:
    name: "{{vitam_docker_name}}"
    image: "{{docker_registry_hostname}}/vitam/ingest:{{vitam_docker_tag}}"
    state: started
    restart_policy: always
    pull: always
    ports:
      - "{{vitam_docker_port_http}}:{{vitam_docker_port_internal}}"
    volumes: 
      - "{{vitam_folder_conf}}:/vitam/conf"
      - "{{vitam_folder_log}}:/vitam/log"
      - "{{vitam_folder_data}}:/vitam/data"
