---

#### Kibana installation ####

- name: Install kibana package from repo
  package:
    name: kibana
    state: latest
  notify:
    - systemctl reload-daemon
    - restart kibana

- name: Add kibana autostart at boot
  service:
    name: kibana
    enabled: yes
  notify:
    - restart kibana

- name: Configure Kibana connection to elasticsearch
  replace:
    dest: /opt/kibana/config/kibana.yml
    regexp: '^# elasticsearch\.url:.*$'
    replace: "elasticsearch.url: \"http://{{elasticsearch_host}}:{{elasticsearch_port}}\""
  notify:
    - restart kibana

- name: Configure basePath for reverse if one is declared in the inventory
  replace:
    dest: /opt/kibana/config/kibana.yml
    regexp: '^# server.basePath:.*$'
    replace: "server.basePath: \"/kibana_{{groupe}}\""
  when: groups['reverse']|length > 0
  notify:
    - restart kibana

- name: Configure Kibana web listening
  replace:
    dest: /opt/kibana/config/kibana.yml
    regexp: '^# server\.host:.*$'
    replace: "server.host: \"{{ip_service}}\""
  notify:
    - restart kibana

#### Consul configuration ####

- name: Ensure consul config dir is OK
  file:
    path: "{{consul_folder_conf}}"
    state: directory
    owner: "{{ vitam_user }}"
    group: "{{ vitam_group }}"

- name: Deploy consul agent service declaration
  template:
    src: "service-kibana.json.j2"
    dest: "{{consul_folder_conf}}/service-{{ kibana_service_name }}.json"
    owner: "{{ vitam_user }}"
    group: "{{ vitam_group }}"
    mode: "{{vitam_conf_permission}}"
  notify:
   - reload consul configuration


