---
# tasks file for kibana_log_dashboards

# Note pour exporter des dashboards
# Pour export des dashboards, se mettre dans le dossier des JSON au niveau du rôle ansible, exécuter la commande : 
# for dashboard in `ls`;do ID=$(echo $dashboard | sed -e "s/\.json//g"); echo $ID; curl "http://172.17.0.2/kibana_log/api/kibana/dashboards/export?dashboard=$ID" >> kibana6_$ID.json;done

#### Kibana dashboards configuration ####

- name: check wether replica number for metrics-vitam is compatible with inventory
  fail: msg="Too much replica defined for metrics index in elasticsearch-log"
  when: groups['hosts-elasticsearch-log']|length <= kibana.log.metrics.replica and groups['hosts-elasticsearch-log']|length>1
  tags: load_kibana_log

- name: Wait for the kibana port to be open
  wait_for:
    host: "{{ ip_service }}"
    port: "{{ kibana.log.port }}"
    timeout: "{{ vitam_defaults.services.start_timeout }}"
  run_once: true
  tags: load_kibana_log

- name: Wait until kibana service is OK
  uri:
    url: 'http://{{ip_service}}:{{ kibana.log.port }}/status'
    method: GET
    #status_code: 200,302
  register: kibana_result
  until: kibana_result.status != 503
  retries: "{{ kibana.log.api_call_timeout }}"
  delay: 1
  tags: load_kibana_log

- name: Modify response & convert to dict...
  set_fact:
    kibana_header: "{{ kibana_result |regex_replace('\\-', '_')}}"
  tags: load_kibana_log

#- debug: msg="{{ kibana_header.kbn_version }}"

### elasticsearch log configuration and kibana configuration ###
# - name: load vitam metrics template in Elasticsearch Log
#   when: "{{ (groups['hosts-kibana-log'] | length) > 0}}"
#   run_once: true
#   uri:
#     url: "{{ elasticsearch.log|client_url }}_template/metrics_template"
#     method: PUT
#     body: "{{ lookup('template', '{{ role_path }}/templates/metrics.template.json.j2') }}"
#     body_format: json
#     status_code: 200,201

# OMA: this is a beurk task but sometimes, .kibana exists & is populated but nothing seen in webapp
# - name: delete current .kibana
#   run_once: true
#   uri:
#     url: "{{ elasticsearch.log|client_url }}.kibana"
#     method: DELETE
#     status_code: 200,404

# - name: create .kibana
#   run_once: true
#   uri:
#     url: "{{ elasticsearch.log|client_url }}.kibana"
#     method: PUT
#     body: '{ "index.mapper.dynamic": true }'
#     body_format: json
#     status_code: 200

# We have a specific task for index pattern to add the "*" at the end of the url
- name: load index templates for Kibana
  when: "{{ (groups['hosts-kibana-log'] | length) > 0 }}"
  run_once: true
  tags: load_kibana_log
  uri:
    url: "http://{{ip_service}}:{{ kibana.log.port }}/api/saved_objects/index-pattern/{{ item | basename | regex_replace('\\.json$') }}*?overwrite=true"
    method: POST
    body: "{\"attributes\": {{ lookup('file', '{{ item }}') }} }"
    body_format: json
    status_code: 200, 201
    timeout: "{{ kibana.log.api_call_timeout }}"
    headers:
      kbn-version: "{{ kibana_header.kbn_version }}"
  with_fileglob: 
    - "{{ role_path }}/files/kibana-metrics-configuration/index-pattern/*.json"

- name: load search into Elasticsearch log .kibana index
  when: "{{ (groups['hosts-kibana-log'] | length) > 0 }}"
  run_once: true
  tags: load_kibana_log
  uri:
    url: "http://{{ip_service}}:{{ kibana.log.port }}/api/saved_objects/search/{{ item | basename | regex_replace('\\.json$') }}?overwrite=true"
    method: POST
    body: "{\"attributes\": {{ lookup('file', '{{ item }}') }} }"
    body_format: json
    status_code: 200, 201
    timeout: "{{ kibana.log.api_call_timeout }}"
    headers:
      kbn-version: "{{ kibana_header.kbn_version }}"
  with_fileglob: 
    - "{{ role_path }}/files/kibana-metrics-configuration/search/*.json"

- name: load visualizations into Elasticsearch log .kibana index
  when: "{{ (groups['hosts-kibana-log'] | length) > 0 }}"
  run_once: true
  tags: load_kibana_log
  uri:
    url: "http://{{ip_service}}:{{ kibana.log.port }}/api/saved_objects/visualization/{{ item | basename | regex_replace('\\.json$') }}?overwrite=true"
    method: POST
    body: "{\"attributes\": {{ lookup('file', '{{ item }}') }} }"
    body_format: json
    status_code: 200, 201
    timeout: "{{ kibana.log.api_call_timeout }}"
    headers:
      kbn-version: "{{ kibana_header.kbn_version }}"
  with_fileglob: 
    - "{{ role_path }}/files/kibana-metrics-configuration/visualization/*.json"

- name: load dashboards into Elasticsearch log .kibana index
  when: "{{ (groups['hosts-kibana-log'] | length) > 0 }}"
  run_once: true
  tags: load_kibana_log
  uri:
    url: "http://{{ip_service}}:{{ kibana.log.port }}/api/saved_objects/dashboard/{{ item | basename | regex_replace('\\.json$') }}?overwrite=true"
    method: POST
    body: "{\"attributes\": {{ lookup('file', '{{ item }}') }} }"
    body_format: json
    status_code: 200, 201
    headers:
      kbn-version: "{{ kibana_header.kbn_version }}"
    timeout: "{{ kibana.log.api_call_timeout }}"
  with_fileglob: 
    - "{{ role_path }}/files/kibana-metrics-configuration/dashboard/*.json"

# OMA : tout est OK, et pourtant... Ne marche pas !
- name: set logstash-vitam* as kibana default index pattern
  when: "{{ (groups['hosts-kibana-log'] | length) > 0}}"
  tags: load_kibana_log
  run_once: true
  uri:
    url: "http://{{ip_service}}:{{ kibana.log.port }}/api/kibana/settings"
    method: POST
    body: '{"changes":{"defaultIndex":"logstash-vitam*"}}'
    headers:
      kbn-version: "{{ kibana_header.kbn_version }}"
    body_format: json
    status_code: 200, 201
    timeout: "{{ kibana.log.api_call_timeout }}"
