---

#### Logstash installation ####

- name: Install java (prerequisite for other components)
  yum:
    name: java-1.8.0
    state: latest
  when: ansible_distribution == "CentOS"

- name: install openjdk from jessie-backports only when Debian
  apt:
    name: openjdk-8-jre-headless
    state: latest
    default_release: jessie-backports
  when: ansible_distribution == "Debian"

- name: Install logstash package from repo
  package:
    name: logstash
    state: latest
  notify:
    - restart logstash

- name: Enable logstash
  service:
    name: logstash
    enabled: yes
  notify:
    - restart logstash

## Logstash configuration

- name: Ensure logstash directories exist
  file:
    path: "{{vitam_folder_root}}/{{item}}/logstash"
    owner: logstash
    state: directory
    mode: "{{vitam_folder_permission}}"
  with_items:
    - data
    - log
    - conf
    - lib
  notify:
    - restart logstash

- name: ensure json conf extra  directory exists
  file:
    path: "{{logstash_confextra_dir}}"
    owner: logstash
    state: directory
    mode: "{{vitam_folder_permission}}"
  notify:
    - restart logstash

- name: apply configuration files
  template:
    src: "{{item}}.j2"
    dest: "/etc/logstash/{{item}}"
    owner: root
    mode: 0644
  with_items:
    - "jvm.options"
    - "log4j2.properties"
    - "startup.options"
    - "logstash.yml"
  notify:
    - restart logstash

- name: configure logstash parser
  template:
    src: "{{item}}.j2"
    dest: "{{logstash_conf_dir}}/{{item}}"
    owner: logstash
    mode: "{{ vitam_conf_permission }}"
  with_items:
    - "01-logstash-vitam-input.conf"
    - "02-logstash-vitam-filter.conf"
    - "03-logstash-vitam-output.conf"
  notify:
    - restart logstash

- name: add vitam patterns conf
  template:
    src: "vitam-patterns.j2"
    dest: "/usr/share/logstash/vendor/bundle/jruby/1.9/gems/logstash-patterns-core-4.1.2/patterns/vitam"
    owner: logstash
  notify:
    - restart logstash


# - name: configure extra parser configuration
#   template:
#     src: "{{item}}.j2"
#     dest: "{{logstash_conf_dir}}/extra/{{item}}"
#     owner: logstash
#     mode: "{{ vitam_conf_permission }}"
#   with_items:
#     - "elasticsearch-template.json"
#   notify:
#     - restart logstash

#### Consul configuration ####

- name: Ensure consul config dir is OK
  file:
    path: "{{consul_folder_conf}}"
    state: directory
    owner: "{{ vitam_user }}"
    group: "{{ vitam_group }}"

- name: Deploy consul agent service declaration
  template:
    src: "service-{{ item }}.json.j2"
    dest: "{{consul_folder_conf}}/service-{{ item }}.json"
    owner: "{{ vitam_user }}"
    group: "{{ vitam_group }}"
    mode: "{{vitam_conf_permission}}"
  with_items:
    - logstash
  notify:
   - reload consul configuration

- name: Ensure consul service is started
  service:
    name: "vitam-consul"
    state: started

- name: Ensure logstash service is started
  service:
    name: "logstash"
    state: started
