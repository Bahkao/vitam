---

- name: Install prometheus node exporter package
  package:
    name: vitam-node-exporter
    state: latest
  register: result
  retries: "{{ packages_install_retries_number }}"
  until: result is succeeded
  delay: "{{ packages_install_retries_delay }}"
  notify:
    - restart prometheus node exporter

- name: Apply prometheus node exporter sysconfig default
  template:
    src: "node-exporter.j2"
    dest: "{{ prometheus_node_exporter_config_path }}/sysconfig/node_exporter"
    owner: "{{ vitam_defaults.users.vitam }}"
    group: "{{ vitam_defaults.users.group }}"
    mode: "{{ vitam_defaults.folder.conf_permission }}"
  notify:
    - restart prometheus node exporter
    
- name: Enable prometheus node exporter service
  service:
    name: vitam-node-exporter
    enabled: true
  notify:
      - restart prometheus node exporter

#### Configuration ####

- name: Check that the node exporter directories exist
  file:
    path: "{{ vitam_defaults.folder.root_path }}/{{ item }}/node-exporter"
    state: directory
    owner: "{{ vitam_defaults.users.vitam }}"
    group: "{{ vitam_defaults.users.group }}"
    mode: "{{ vitam_defaults.folder.folder_permission }}"
  with_items:
    - app
    - bin
    - conf
    - lib
    - log
    - data
    - tmp
  notify:
    - restart prometheus node exporter

# Ensure that the installation is complete
- meta: flush_handlers
  tags:
    - node_exporter_tag

- name: Ensure vitam node exporter service is started
  service:
    name: vitam-node-exporter
    state: started
  tags:
    - node_exporter_tag
