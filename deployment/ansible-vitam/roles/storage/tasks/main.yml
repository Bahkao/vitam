---
# tasks file for storage-engine
- name: copy file for driver in data
  template:
    src: "fr.gouv.vitam.storage.offers.workspace.driver.DriverImpl"
    dest: "{{vitam_folder_data}}/fr.gouv.vitam.storage.offers.workspace.driver.DriverImpl"
    owner: "{{vitam_user}}"
    group: "{{vitam_group}}"
    mode: "{{vitam_conf_permission}}"
  notify:
    - restart service

- name: copy the systemd unit & timer files for curator
  template:
    src: "{{role_path}}/templates/systemd/{{item}}.j2"
    dest: "/usr/lib/systemd/system/{{item}}"
  with_items: "{{ lookup('pipe','find {{role_path}}/templates/systemd/ -type f  -exec basename {} .j2 \\; || true').split('\n') }}"
  when: "ansible_distribution == 'CentOS' and {{ lookup('pipe', 'test -d {{role_path}}/templates/systemd || echo nofolder') == \"\" }}"

- name: copy the systemd unit & timer files for curator
  template:
    src: "{{role_path}}/templates/systemd/{{item}}.j2"
    dest: "/lib/systemd/system/{{item}}"
  with_items: "{{ lookup('pipe','find {{role_path}}/templates/systemd/ -type f  -exec basename {} .j2 \\; || true').split('\n') }}"
  when: "ansible_distribution == 'Debian' and {{ lookup('pipe', 'test -d {{role_path}}/templates/systemd || echo nofolder') == \"\" }}"

- name: Enable systemd timers
  systemd:
    name: "{{item}}"
    daemon_reload: "yes"
    enabled: "yes"
    state: "started"
  with_items: "{{ lookup('pipe','find {{role_path}}/templates/systemd/ -type f -name *.timer.j2 -exec basename {} .j2 \\; || true').split('\n') }}"
  when: "{{ lookup('pipe', 'test -d {{role_path}}/templates/systemd || echo nofolder') == \"\" }}"

- name: Ensure service is started
  service:
    name: "vitam-{{ vitam_component }}"
    state: started
