Utilisation des resources informatiques
#######################################

.. caution:: Les abaques de dimensionnement sont en cours de définition ; les éléments présentés ci-dessous correspondent aux cibles de dimensionnement en cours de test ou prévus pour les tests de performance. Les indications de volumétrie qui y sont présentées sont purement indicatives, et relatives au système VITAM dans son état actuel, à savoir au tout début de la phase de tuning et d'optimisations des performances. En outre, ils se basent sur des tests sur systèmes virtualisés (avec une surallocation CPU de 4), et comprennent une réservation de resources pour chaque OS.

.. note:: Sauf mention contraire, les enveloppes de resources ci-dessous comprennent notamment les composants associés à l'exploitation de la solution VITAM et fournis dans le cadre de la solution (traitement et stockage des logs et des métriques, gestion des bases de données, ...)


Eléments de dimensionnement
===========================

Compute
-------

Configurations indicatives pour le développement et/ou la recette d'applications métier :

* Configuration "xsmall" : 1 VM (4 vCPU, 16 Go RAM) : adapté à un poste de développement ; ce déploiement ne comprend pas les composants d'exploitation de la solution VITAM ; en outre, le même cluster MongoDB est utilisé pour les logs d'écriture du stockage et les logs 
* Configuration "small" : 3 VM (18 vCPU, 36 Go RAM) : adapté à un environnement de recette simple d'application métier utilisant VITAM ;

Configurations indicatives pour la production :

* Configuration "medium" : déploiement à 15 VM (44 vCPU, 80 Go RAM) : déploiement simple pour des volumétries moyennes ; seules les bases de données et les offres de stockage sont multi-instanciées ;
* Configuration "large" : déploiement à 31 VM ( 92 vCPU, 172 Go RAM) : déploiement résilient pour des volumétries plus importantes ; ce déploiement comprend au moins deux instances pour tous les composants le supportant et deux offres de stockage ;
* Configuration "xlarge" : déploiement à 58 VM (212 vCPU, 412 Go RAM) : déploiement pour de fortes volumétries (ordre de grandeur des capacités d'ingest : > 50 To / an, > 100.10^6 objets / an) ;

De manière générale, la consommation en resources (CPU/RAM/réseau) de VITAM dépend de 3 grands cas d'utilisation :

* La quantité d'archives versées (ingest) : supporter plus d'ingest nécessite de renforcer les resources disponibles pour les composants actifs lors d'un ingest : ingest-external, ingest-internal, processing, worker, workspace, storage, storage-offer, logbook, metadata, elasticsearch-data, mongodb ;
* La quantité d'archives gérées (audit & pérennisation) : dans cette version de VITAM, les fonctions liées à ces deux domaines sont limitées ; par conséquent, la quantité de données gérées a uniquement une influence sur les bases de données : elasticsearch-data, mongodb ;
* La quantité d'archives consultées (access) : supporter plus de requêtes concurrentes nécessite de renforcer les resources disponibles pour les composants actifs lors d'une consultation : access-external, access-internal, metadata, storage, storage-offer, elasticsearch-data, mongodb.

.. note:: les composants de référentiels (functional-administration, security-internal), même si ils sont utilisés dans la plupart des scénarii métiér, bénéficient d'un fort effet de cache du côté des clients de ces services ; par conséquent, ils sont moins sensibles que les autres à l'augmentation de capacité.


Stockage
--------


Network : inter-site
--------------------

Un lien réseau IP doit existe entre les deux sites et respecter les flux décrits dans la matrice de flux externes (:doc:`90-flux-all`).

Le routage niveau 3 est permis sur ce lien, par translation d'adresse, mais pas par translation de port (i.e. chaque serveur devant être exposé sur le site 2 au site 1 peut exposer une adresse IP WAN visible depuis le site 1 différente de son adresse IP LAN locale).

Concernant ce lien intersite, les éléments permettant sont dimensionnement sont les suivants :

* La latence est peu critique (elle joue principalment sur la performance des batchs, et pas des accès utilisateurs ; l'optimisation des performances se fera dans ce cas par l'augmentation des pools de threads de storage et l'augmentation de la capacité des worker)
* Par contre, un débit adapté est requis ; dans cette version de VITAM, ce dernier peut se calculer à partir de la somme des débits d'ingest des AU + GOT + BDO + journaux.



Dimensionnement indicatif (ingest uniquement)
=============================================

Voici un exemple de dimensionnement et des performances associées mesurées sur un environnement complètement virtualisé, dimensionné pour des performances :

.. csv-table:: Dimensionnement de l'environnement de recette de performance VITAM (V1)
	:header-rows: 1
	:file: data/sizing-perf.csv
	:delim: ;

.. caution:: Les serveurs mongoDB pour les offres sont surdimensionnés dans ce dimensionnement. Ce dernier n'est mentionné ici que par transparence vis-à-vis des résultats présentés ci-après. Le dimensionnement actualisé est la dimensionnement "xlarge" présenté à la section précédente (qui possède les mêmes performances sur nos tests de comparaison).

La plate-forme d'exécution est la suivante :

* Cloud OpenStack
* Flavors : règles imposée de 1 vCPU = 4 Go RAM
* CPU : Intel Broadwell, 2,6 Ghz
* Disques : disques attachés au réseau (back-end Cinder Ceph)
* Réseau : Réseau virtuel au-dessus d'un coeur de réseau 10 Gbps
* Configuration des workers : capacité de 8
* Contenu initial des bases de données (mongo-data et elasticsearch-data) : 100 000 000 AU + GOT artificielles parasites

Les performances atteintes à l'ingest sont les suivantes :

* Ingest de SIP avec de nombreux objets :

    - Typologie des SIP : 100 000 AU/GOT/BDO de 1 Ko
    - Résultats : 1h16m

* Ingest d’objets binaires volumineux sur offre filesystem

    - Un SIP avec un objet de 5 Go : 7 min
	- Un SIP avec un objet de 17 Go : 18 min 

* Ingest - Endurance :

    - Ingest sur 10 threads en parallèle pendant 20 h
	- Typologie des SIP : 2500 AU/GOT/BDO de 100 Ko
    - Résultats : 170 000 (AU+GOT+BDO)/h

* Audit : Update d’AU suite à modification d’une règle de gestion

    - 5 000 AU traitées par minute

* Audit : présence d’objets

    - 4 millions d’AU traitées en 1h30

* Audit : intégrité des objets binaires

    - 1 million d’AU et 1,4 million de BDO traités en 3h


