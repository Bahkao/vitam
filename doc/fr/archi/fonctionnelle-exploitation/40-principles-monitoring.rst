Suivi de l'état du système
##########################



API de supervision
==================

Il doit exposer en interne de la plate-forme les API REST suivantes :

* ``/admin/v1/status`` : statut simple, renvoyant un statut de fonctionnement incluant des informations techniques sur l'état actuel du composant. Un exemple d'utilisation typique est l'intégration à un outil de supervision ou à un élément actif tiers (ex: load-balancer, ...) . L'appel doit être peu coûteux.

.. note:: D'autres API de supervision seront disponibles dans les versions ultérieures de la solution VITAM (notamment reliées à des tests internes des services plus complets et à l'exposition de métriques de performance)

.. seealso:: D'autres interfaces de status dédiées au SIA sont disponibles sur les composants externes (zone accès) ; elles sont décrites dans la documentation d'API de VITAM.


Métriques
=========

L'intégration de certaines métriques de performance est en cours d'inclusion dans cette version de la solution VITAM ; ces métriques correspondent aux éléments suivants remontés pour chaque endpoint REST du système :

* Fréquence d'appel sur les dernière 1, 5 et 15 minutes ;
* Nombre de résultats selon le code HTTP renvoyé ;
* Avec un sampling des temps de réponses biaisé sur les 5 dernières minutes :

    - Le minimum
    - Le maximum
    - La moyenne
    - L'écart type
    - Le 95ème percentile

Chaque service doit exposer un endpoint REST permettant de récupérer ces métriques.

.. caution:: L'inclusion de ces métriques (et de leur centralisation) dans cette version de VITAM n'est  pas garantie ; les prochaines versions de ce document présenteront un état actualisé sur ce sujet.


Logs
====

Protocoles : syslog
-------------------

Les protocoles d'emission de logs (entre un émetteur de logs et l'agent syslog local) possibles sont : 

  + Le format syslog unix (écriture dans ``/dev/log``), privilégié pour les messages émis par les scripts shell (protocole par défaut de la commande logger) . 
  + Le format syslog udp (sans garantie d'acheminement), privilégié pour les messages émis par les applications.

Dans les deux cas, et en se basant sur la RFC 5424, les paramètres imposés sur les messages syslog sont les suivants :

* Facility : ``local0`` (id 21) ; Vitam n'utilise pas les facilités "système" mais seulement les facilités local0 à local3.
* Message Severity : dans le cas des applications Java, le mapping de sévérité suit le mapping imposé par `l'appender logback SyslogAppender  <http://logback.qos.ch/manual/appenders.html#SyslogAppender>`_ (``DEBUG`` 7, ``INFO`` 6, ``WARN`` 4 et ``ERROR`` 3).
* Le positionnement du champ ``APP-NAME`` correspondant à l'application ; pour les applications VITAM, ce champ doit être égal à l'id du composant vitam (devant respecter le pattern ``vitam-.*``). Pour les scripts, il doit être égal au nom du script (comportement par défaut pour un logger unix)
 
.. note:: A noter que l'instance de l'application n'est pas mise dans le champ ``APP-NAME`` car du fait des principes de packaging, il ne peut y avoir qu'une seule instance d'application par OS et le tuple (``HOSTNAME``, ``APPNAME``) identifie bien l'application.


Types de log
------------

Les logs se divisent en plusieurs catégories :

Logs applicatifs
^^^^^^^^^^^^^^^^

Les logs applicatifs couvrent les logs produits par le code des applications ; ils permettent de suivre un certain nombre d'évènements techniques et métiers remontés par les applications.

Leur format est imposé par VITAM (se reporter au :term:`DEX` pour le format exact des logs).

Par défaut, ces logs sont déposés de deux manières différentes :

* des fichiers de logs (dans le répertoire de log dédié pour chaque composant (Cf. la :doc:`section dédiée <02-principles-users-rights>`)). Ils sont configurés pour rouler quotidiennement, avec une taille globale maximale ; le pattern des fichiers est ``<service_id>.%d.log``(``%d`` étant remplacé par ``yyyy-MM-dd``)
  
* le service syslog local, en utilisant le protocole syslog UDP (port 514 ; format défini dans la RFC3164).

.. note:: VITAM propose un sous-système dédié à la collecte et exploitation des logs qui s'appuie sur ce service syslog local pour l'acquisition des logs ; il est décrit plus en détails dans :doc:`la section dédiée </technique/05-logs-architecture>`.


Logs du garbage collector Java
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Ces logs permettent de faire une analyse fine du fonctionnement interne de la JVM à travers les informations d'exécution des différents garbage collectors. 

Leur format est imposé par l'implémentation de la :term:`JVM`.

Ils sont déposés dans des fichiers (dans le répertoire de log dédié pour chaque composant (Cf. la :doc:`section dédiée <02-principles-users-rights>`)) : ``gc/gc.log`` pour le fichier courant, ``gc.log.<n>`` pour les fichiers roulés (avec ``<n>`` le numéro du fichier, sur base 0). Le roulement est basé sur une limite de taille unitaire des fichiers, avec un nombre maximal de fichiers.


Logs d'accès
^^^^^^^^^^^^

Les logs d'accès sont placés sur tous les services métiers VITAM ; ils permettent de tracer de manière fine (avec une granularité à la requête) les appels de ces services.

Leur format est imposé par VITAM (se reporter au :term:`DEX` pour le format exact des logs).

Ces logs sont déposés dans des fichiers (dans le répertoire de log dédié pour chaque composant (Cf. la :doc:`section dédiée <02-principles-users-rights>`)). Ils sont configurés pour rouler quotidiennement, avec une taille globale maximale ; le pattern des fichiers est ``accesslog-<service_id>.%d.log``(``%d`` étant remplacé par ``yyyy-MM-dd``)









.. 
    Suivi de l'état de sécurité
    ===========================
.. 
    Sujet à adresser


.. 
    Suivi de l'état de déploiement
    ==============================
.. 
    Sujet à adresser ; à définir en liaison avec la section sur :doc:`le déploiement <30-principles-deployment>`


.. A intégrer à l'ihm d'administration technique ?


Intégration à un système de monitoring tiers
============================================

L'intégration à un système de monitoring tiers est possible via les points d'extension suivants :

* Les API REST de monitoring des composants Java
