Sauvegarde / restauration
##########################

.. warning:: Cette méthode n'est pas recommandée pour un usage en production, du fait de la volumétrie générée.

Les procédures sont issues des documentations officielles :

* mongoDB : https://docs.mongodb.com/manual/tutorial/backup-and-restore-tools/
* elasticsearch : https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-snapshots.html

Sauvegarde
==========

.. note:: Pour que cette sauvegarde soit fonctionnellement correcte, il faut que la solution logicielle :term:`VITAM` soit dans un état stable et cohérent, sans possibilité d'ajouter des "ingests" et sans travail de fond (jobs de sécurisation, ...).

mongoDB
--------

La commande suivante est à lancer depuis une machine mongo de :term:`VITAM` ayant un espace suffisant dans le répertoire de sauvegarde (défini par ``--out``) :

    mongodump --host mongodb.example.net --port 27017 --out /data/backup/ --username vitamdb-admin --password "pass"

.. info:: Se reporter aux fichiers associés à l'ansiblerie de déploiement pour le mot de passe ``vitamdb-admin`` 

Rapatrier sur un serveur le produit généré dans la valeur de ``--out``.

Pour rappel, il y a un clustyer mongo de "data", ainsi qu'un cluster mongo "offer" associé à chaque offre.

Elasticsearch
-------------

La commande suivante est à lancer depuis une machine elasticsearch de :term:`VITAM` ayant un espace suffisant dans le répertoire de sauvegarde  :

    curl -X PUT http://eltasicsearch-data.service.${consul_domain}:9200/_snapshot/vitam_backup -d '{ "type": "fs", "settings": { "location": "${output_dir}" } }'
    

.. note:: renseigner correctement l'arborescence où vous souhaitez sauvegarder...

    curl -X POST http://eltasicsearch-data.service.${consul_domain}:9200/_snapshot/my_unverified_backup/_verify
    curl -X PUT http://eltasicsearch-data.service.${consul_domain}:9200/_snapshot/vitam_backup/snapshot_1?wait_for_completion=true


Restauration
=============

.. note:: comme pour la sauvegarde, la restauration ne peut s'effectuer que sur un environnement :term:`VITAM` stable et cohérent, sans possibilité d'ajouter des "ingests" et sans travail de fond (jobs de sécurisation, ...).

mongoDB
----------

.. warning:: une sauvegarde ne peut se restaurer que sur un environnement dans la même version.

La commande suivante est à lancer depuis une machine mongo de :term:`VITAM` possédant le répertoire de sauvegarde à restaurer :

    mongorestore --host mongodb1.example.net --port 3017 --username vitamdb-admin --password 'pass' /opt/backup/mongodump-2013-10-24

.. info:: Se reporter aux fichiers associés à l'ansiblerie de déploiement pour le mot de passe ``vitamdb-admin`` 


Elasticsearch
-------------
    
    curl -X GET http://eltasicsearch-data.service.${consul_domain}:9200/_snapshot

Cette commande liste les *SNAPSHOT* disponibles ; placer ce nom à la place de *snapshot* dans l'URL suivante :

    curl -X POST http://eltasicsearch-data.service.${consul_domain}:9200/_snapshot/vitam_backup/*snapshot*/_restore

