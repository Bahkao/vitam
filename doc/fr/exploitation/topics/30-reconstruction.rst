Reconstruction
##############

La reconstruction consiste à recréer le contenu des bases de données (MongoDB, Elasticsearch-data) en cas de perte de l'une ou l'autre à partir des informations présentes dans les offres de stockage. Elle part du principe que le contenu des offres n'a pas été altéré.

.. note:: La reconstruction complète

.. caution:: Dans cette version de la solution logicielle VITAM, la reconstruction nécessite de couper le service aux utilisateurs.

.. caution:: Une reconstruction complète à partir des offres de stockage peut être extrêmement longue, et ne doit être envisagée qu'en dernier recours.

.. TODO A vérifier

Déclenchement
=============

.. TODO : A préciser (avec les bonnes commandes)

Cas du site primaire :
----------------------

.. TODO Import mongodump de identity à documenter, sauf que si on a perdu la base avant, pas de dump...

La reconstruction se réalise de la manière suivante :

* Arrêt de VITAM sur le site à reconstruire ;
* Purge des données (le cas échéant) stockées dans mongodb. ATTENTION: ne pas supprimer les index des différentes collections ;
* Purge des données (le cas échéant) stockées dans elasticsearch ;
* Reconfiguration et démarrage en tant que site secondaire ;
    - Dès lors, l'accès utilisateur reste coupé, et l'intégralité des données est reconstruit progressivement ;
    - Le suivi de la reconstruction se fait en observant l'évolution de l'offset de reconstruction stocké dans MongoDB.
* Une fois la reconstruction terminée, reconfiguration et démarrage en tant que site primaire.

Cas du site secondaire :
------------------------

La reconstruction se réalise de la manière suivante :

* Arrêt de VITAM sur le site à reconstruire ;
* Purge des données (le cas échéant) stockées dans mongodb. ATTENTION: ne pas supprimer les index des différentes collections ;
* Purge des données (le cas échéant) stockées dans elasticsearch ;
* Redémarrage du site secondaire Vitam
    - La prochaine itération de reconstruction au fil de l'eau redémarrera la reconstruction à partir du début
    - Le suivi de la reconstruction se fait en observant l'évolution de l'offset de reconstruction stocké dans MongoDB.
